<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Panel de Datos de Salud (Mejorado)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #f0f2f5;
            color: #1c1e21;
            margin: 0;
            padding: 20px;
        }
        .container { max-width: 1200px; margin: auto; }
        .header { text-align: center; margin-bottom: 30px; }
        .header h1 { color: #0d47a1; }

        /* Mejora 3: Área de carga con drag-and-drop */
        #drop-area {
            border: 2px dashed #007bff;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            margin-bottom: 20px;
            background-color: #fff;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        #drop-area.highlight { background-color: #e9f5ff; }
        #drop-area p { margin: 0; color: #555; font-size: 1.1em; }

        #file-input { display: none; }
        #loader { display: none; text-align: center; padding: 20px; }
        
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
        }

        /* Mejora 2: Diseño de "Tarjeta" */
        .card {
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            padding: 20px;
            transition: box-shadow 0.3s;
        }
        .card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .card h2 { margin-top: 0; color: #333; }
        
        /* Mejora 4: Estilo para estadísticas */
        .stats-container {
            display: flex;
            justify-content: space-around;
            text-align: center;
            margin: 10px 0 20px 0;
            padding: 10px;
            background: #f9f9f9;
            border-radius: 5px;
        }
        .stat p { margin: 0; font-size: 0.9em; color: #666; }
        .stat h3 { margin: 5px 0 0 0; color: #0056b3; }

    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Panel de Datos de Salud Personalizados</h1>
        </div>
        
        <div id="drop-area">
            <p>Arrastra y suelta tu archivo <strong>datos_salud.xlsx</strong> aquí, o haz clic para seleccionarlo.</p>
            <input type="file" id="file-input" accept=".xlsx">
        </div>

        <div id="loader">
            <p>Cargando y procesando datos...</p> <!-- Aquí podrías añadir un spinner SVG/CSS -->
        </div>

        <div id="charts-container" class="charts-grid" style="display:none;">
            <div class="card">
                <h2>Presión Arterial (mmHg)</h2>
                <div id="bp-stats" class="stats-container"></div>
                <canvas id="bpChart"></canvas>
            </div>
            <div class="card">
                <h2>Glucosa (mg/dL)</h2>
                <div id="glucose-stats" class="stats-container"></div>
                <canvas id="glucoseChart"></canvas>
            </div>
            <div class="card">
                <h2>Peso (kg)</h2>
                <div id="weight-stats" class="stats-container"></div>
                <canvas id="weightChart"></canvas>
            </div>
        </div>
    </div>

    <!-- index.html (solo el script) -->
<script>
    // Referencias a los elementos del DOM
    const API_URL = 'https://panel-salud-api.onrender.com'; // Por favor, verifica de nuevo que esta URL sea 100% idéntica a la de Render.
    const fileInput = document.getElementById('file-input');
    const loader = document.getElementById('loader');
    
    // Contenedores
    const chartsContainer = document.getElementById('charts-container');
    const bpCard = document.querySelector('#bpChart').parentElement;
    const glucoseCard = document.querySelector('#glucoseChart').parentElement;
    const weightCard = document.querySelector('#weightChart').parentElement;
    
    const dropArea = document.getElementById('drop-area');

    // --- MANEJO DE ARCHIVOS Y COMUNICACIÓN CON LA API ---
    async function handleFile(file) {
        console.log("1. Función handleFile iniciada."); // Punto de control 1

        if (!file || !file.name.endsWith('.xlsx')) {
            alert('Por favor, selecciona un archivo Excel (.xlsx).');
            return;
        }

        loader.style.display = 'block';
        chartsContainer.style.display = 'none';

        const formData = new FormData();
        formData.append('file', file);
        
        console.log("2. A punto de hacer la llamada 'fetch' a:", API_URL + '/upload-data'); // Punto de control 2

        try {
            const response = await fetch(`${API_URL}/upload-data`, {
                method: 'POST',
                body: formData,
            });

            console.log("3. Respuesta 'fetch' recibida. Estado:", response.status); // Punto de control 3

            if (!response.ok) {
                const errorData = await response.json();
                console.error("Error del servidor:", errorData);
                throw new Error(errorData.detail || 'Ocurrió un error en el servidor.');
            }
            
            const result = await response.json();
            console.log("4. Datos recibidos del servidor:", result); // Punto de control 4
            
            chartsContainer.style.display = 'grid';
            renderAllComponents(result.data);

        } catch (error) {
            console.error("ERROR CAPTURADO EN EL BLOQUE CATCH:", error); // Punto de control de error
            alert(`Error en la comunicación con la API: ${error.message}`);
        } finally {
            console.log("5. Bloque 'finally' ejecutado. Ocultando cargador.");
            loader.style.display = 'none';
        }
    }

    // --- RESTO DE FUNCIONES (Sin cambios, puedes dejarlas como están) ---
    function renderAllComponents(data) { /*...*/ }
    function calculateStats(data) { /*...*/ }
    function displayStats(stats) { /*...*/ }
    function createCharts(data, stats) { /*...*/ }
    function preventDefaults(e) { /*...*/ }

    // ... (Copia aquí el resto de las funciones desde el código anterior)
    
     // El resto del script...
    function renderAllComponents(data) {
        if (!data || data.length === 0) return;
        const stats = calculateStats(data);
        displayStats(stats);
        createCharts(data, stats);
    }
    function calculateStats(data) {
        const sistolica = data.map(d => d['PA Sistólica']); const diastolica = data.map(d => d['PA Diastólica']); const glucosa = data.map(d => d['Glucosa (mg/dL)']); const peso = data.map(d => d['Peso (kg)']);
        return { lastSistolica: sistolica[sistolica.length - 1], lastDiastolica: diastolica[diastolica.length - 1], avgSistolica: (sistolica.reduce((a, b) => a + b, 0) / sistolica.length).toFixed(0), avgDiastolica: (diastolica.reduce((a, b) => a + b, 0) / diastolica.length).toFixed(0), lastGlucosa: glucosa[glucosa.length - 1], avgGlucosa: (glucosa.reduce((a, b) => a + b, 0) / glucosa.length).toFixed(0), lastPeso: peso[peso.length - 1], totalChangePeso: (peso[peso.length - 1] - peso[0]).toFixed(1) };
    }
    function displayStats(stats) {
        document.getElementById('bp-stats').innerHTML = `<div class="stat"><p>Última</p><h3>${stats.lastSistolica} / ${stats.lastDiastolica}</h3></div><div class="stat"><p>Promedio</p><h3>${stats.avgSistolica} / ${stats.avgDiastolica}</h3></div>`; document.getElementById('glucose-stats').innerHTML = `<div class="stat"><p>Última</p><h3>${stats.lastGlucosa} mg/dL</h3></div><div class="stat"><p>Promedio</p><h3>${stats.avgGlucosa} mg/dL</h3></div>`; document.getElementById('weight-stats').innerHTML = `<div class="stat"><p>Último</p><h3>${stats.lastPeso} kg</h3></div><div class="stat"><p>Cambio</p><h3>${stats.totalChangePeso} kg</h3></div>`;
    }
    function createCharts(data, stats) {
        const labels = data.map(d => d.Fecha);
        bpCard.querySelector('canvas').remove(); glucoseCard.querySelector('canvas').remove(); weightCard.querySelector('canvas').remove();
        bpCard.innerHTML += '<canvas id="bpChart"></canvas>'; glucoseCard.innerHTML += '<canvas id="glucoseChart"></canvas>'; weightCard.innerHTML += '<canvas id="weightChart"></canvas>';
        new Chart(document.getElementById('bpChart').getContext('2d'), { type: 'line', data: { labels: labels, datasets: [{ label: 'Sistólica', data: data.map(d => d['PA Sistólica']), borderColor: 'rgba(211, 47, 47, 1)'}, { label: 'Diastólica', data: data.map(d => d['PA Diastólica']), borderColor: 'rgba(25, 118, 210, 1)'}]}}); new Chart(document.getElementById('glucoseChart').getContext('2d'), { type: 'line', data: { labels: labels, datasets: [{ label: 'Glucosa (mg/dL)', data: data.map(d => d['Glucosa (mg/dL)']), borderColor: 'rgba(56, 142, 60, 1)'}]}}); new Chart(document.getElementById('weightChart').getContext('2d'), { type: 'bar', data: { labels: labels, datasets: [{ label: 'Peso (kg)', data: data.map(d => d['Peso (kg)']), backgroundColor: 'rgba(123, 31, 162, 0.8)'}]}});
    }
    function preventDefaults(e) { e.preventDefault(); e.stopPropagation(); }
    
    // --- EVENT LISTENERS ---
    dropArea.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', (e) => handleFile(e.target.files[0]));
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => dropArea.addEventListener(eventName, preventDefaults));
    ['dragenter', 'dragover'].forEach(eventName => dropArea.addEventListener(eventName, () => dropArea.classList.add('highlight')));
    ['dragleave', 'drop'].forEach(eventName => dropArea.addEventListener(eventName, () => dropArea.classList.remove('highlight')));
    dropArea.addEventListener('drop', (e) => handleFile(e.dataTransfer.files[0]));

</script>
</body>
</html>
