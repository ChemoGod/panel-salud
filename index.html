<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Panel de Datos de Salud (Mejorado)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #f0f2f5;
            color: #1c1e21;
            margin: 0;
            padding: 20px;
        }
        .container { max-width: 1200px; margin: auto; }
        .header { text-align: center; margin-bottom: 30px; }
        .header h1 { color: #0d47a1; }

        /* Mejora 3: Área de carga con drag-and-drop */
        #drop-area {
            border: 2px dashed #007bff;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            margin-bottom: 20px;
            background-color: #fff;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        #drop-area.highlight { background-color: #e9f5ff; }
        #drop-area p { margin: 0; color: #555; font-size: 1.1em; }

        #file-input { display: none; }
        #loader { display: none; text-align: center; padding: 20px; }
        
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
        }

        /* Mejora 2: Diseño de "Tarjeta" */
        .card {
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            padding: 20px;
            transition: box-shadow 0.3s;
        }
        .card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .card h2 { margin-top: 0; color: #333; }
        
        /* Mejora 4: Estilo para estadísticas */
        .stats-container {
            display: flex;
            justify-content: space-around;
            text-align: center;
            margin: 10px 0 20px 0;
            padding: 10px;
            background: #f9f9f9;
            border-radius: 5px;
        }
        .stat p { margin: 0; font-size: 0.9em; color: #666; }
        .stat h3 { margin: 5px 0 0 0; color: #0056b3; }

    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Panel de Datos de Salud Personalizados</h1>
        </div>
        
        <div id="drop-area">
            <p>Arrastra y suelta tu archivo <strong>datos_salud.xlsx</strong> aquí, o haz clic para seleccionarlo.</p>
            <input type="file" id="file-input" accept=".xlsx">
        </div>

        <div id="loader">
            <p>Cargando y procesando datos...</p> <!-- Aquí podrías añadir un spinner SVG/CSS -->
        </div>

        <div id="charts-container" class="charts-grid" style="display:none;">
            <div class="card">
                <h2>Presión Arterial (mmHg)</h2>
                <div id="bp-stats" class="stats-container"></div>
                <canvas id="bpChart"></canvas>
            </div>
            <div class="card">
                <h2>Glucosa (mg/dL)</h2>
                <div id="glucose-stats" class="stats-container"></div>
                <canvas id="glucoseChart"></canvas>
            </div>
            <div class="card">
                <h2>Peso (kg)</h2>
                <div id="weight-stats" class="stats-container"></div>
                <canvas id="weightChart"></canvas>
            </div>
        </div>
    </div>

    <script>
    // Referencias a los elementos del DOM
    const API_URL = 'https://panel-salud-api.onrender.com'; // Asegúrate de que esta URL es la tuya
    const dropArea = document.getElementById('drop-area');
    const fileInput = document.getElementById('file-input');
    const loader = document.getElementById('loader');
    const chartsContainer = document.getElementById('charts-container');
    
    // Variables globales para las instancias de los gráficos
    let bpChart, glucoseChart, weightChart;

    // --- MANEJO DE ARCHIVOS ---

    // Función principal que se activa al subir un archivo
    async function handleFile(file) {
        if (!file || !file.name.endsWith('.xlsx')) {
            alert('Por favor, selecciona un archivo Excel (.xlsx).');
            return;
        }

        loader.style.display = 'block';
        chartsContainer.style.display = 'none';

        const formData = new FormData();
        formData.append('file', file);

        try {
            // Realizar la petición POST a nuestra API de Render
            const response = await fetch(`${API_URL}/upload-data`, {
                method: 'POST',
                body: formData,
            });

            // Si la respuesta no es OK (ej. error 500 del servidor), lanza un error
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.detail || 'Ocurrió un error en el servidor.');
            }
            
            // Si la respuesta es OK, procesa los datos
            const result = await response.json();
            chartsContainer.style.display = 'grid';
            
            // Llama a las funciones para mostrar los datos
            displayStats(result.data); 
            createCharts(result.data);

        } catch (error) {
            // Captura cualquier error (de red o del servidor) y muéstralo
            alert(`Error: ${error.message}`);
        } finally {
            // Siempre oculta el cargador al final
            loader.style.display = 'none';
        }
    }

    // --- FUNCIONES DE CÁLCULO Y VISUALIZACIÓN ---
    
    // Calcula y muestra las estadísticas clave
    function displayStats(data) {
        if (!data || data.length === 0) return;
        
        // ... (código idéntico a antes para Presión, Glucosa y Peso) ...
        const sistolica = data.map(d => d['PA Sistólica']);
        const diastolica = data.map(d => d['PA Diastólica']);
        const avgSistolica = (sistolica.reduce((a, b) => a + b, 0) / sistolica.length).toFixed(0);
        const avgDiastolica = (diastolica.reduce((a, b) => a + b, 0) / diastolica.length).toFixed(0);
        document.getElementById('bp-stats').innerHTML = `
            <div class="stat"><p>Última</p><h3>${sistolica[sistolica.length - 1]} / ${diastolica[diastolica.length - 1]}</h3></div>
            <div class="stat"><p>Promedio</p><h3>${avgSistolica} / ${avgDiastolica}</h3></div>`;
        const glucosa = data.map(d => d['Glucosa (mg/dL)']);
        const avgGlucosa = (glucosa.reduce((a, b) => a + b, 0) / glucosa.length).toFixed(0);
        document.getElementById('glucose-stats').innerHTML = `
            <div class="stat"><p>Última</p><h3>${glucosa[glucosa.length - 1]} mg/dL</h3></div>
            <div class="stat"><p>Promedio</p><h3>${avgGlucosa} mg/dL</h3></div>`;
        const peso = data.map(d => d['Peso (kg)']);
        document.getElementById('weight-stats').innerHTML = `
            <div class="stat"><p>Último</p><h3>${peso[peso.length - 1]} kg</h3></div>
            <div class="stat"><p>Cambio</p><h3>${(peso[peso.length-1] - peso[0]).toFixed(1)} kg</h3></div>`;
    }

    // Crea o actualiza los gráficos
    function createCharts(data) {
        const labels = data.map(d => d.Fecha);
        if (bpChart) bpChart.destroy();
        if (glucoseChart) glucoseChart.destroy();
        if (weightChart) weightChart.destroy();

        // (código de creación de gráficos idéntico a antes)
        const bpCtx = document.getElementById('bpChart').getContext('2d');
        bpChart = new Chart(bpCtx, { type: 'line', data: { labels: labels, datasets: [{ label: 'Sistólica', data: data.map(d => d['PA Sistólica']), borderColor: 'rgba(211, 47, 47, 1)', tension: 0.1 }, { label: 'Diastólica', data: data.map(d => d['PA Diastólica']), borderColor: 'rgba(25, 118, 210, 1)', tension: 0.1 }] }});
        const glucoseCtx = document.getElementById('glucoseChart').getContext('2d');
        glucoseChart = new Chart(glucoseCtx, { type: 'line', data: { labels: labels, datasets: [{ label: 'Glucosa (mg/dL)', data: data.map(d => d['Glucosa (mg/dL)']), borderColor: 'rgba(56, 142, 60, 1)', tension: 0.1 }] }});
        const weightCtx = document.getElementById('weightChart').getContext('2d');
        weightChart = new Chart(weightCtx, { type: 'bar', data: { labels: labels, datasets: [{ label: 'Peso (kg)', data: data.map(d => d['Peso (kg)']), backgroundColor: 'rgba(123, 31, 162, 0.8)' }] }});
    }

    // --- EVENT LISTENERS (ESCUCHADORES DE EVENTOS) ---

    // Funciones para prevenir comportamientos por defecto del navegador al arrastrar
    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }
    
    // Activar los eventos para el área de "drag and drop"
    dropArea.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', (e) => handleFile(e.target.files[0]));
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => dropArea.addEventListener(eventName, preventDefaults));
    ['dragenter', 'dragover'].forEach(eventName => dropArea.addEventListener(eventName, () => dropArea.classList.add('highlight')));
    ['dragleave', 'drop'].forEach(eventName => dropArea.addEventListener(eventName, () => dropArea.classList.remove('highlight')));
    dropArea.addEventListener('drop', (e) => handleFile(e.dataTransfer.files[0]), false);

</script>
</body>
</html>
